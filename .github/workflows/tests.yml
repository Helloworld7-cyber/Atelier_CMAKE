# .github/workflows/tests.yml

name: Pipeline CI/CD

on: push

jobs:
  # ----------------------------------------------------
  # JOB 1 : COMPILATION (Point d'entr√©e du pipeline)
  # ----------------------------------------------------
  Compilation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installer CMake
        run: sudo apt-get update && sudo apt-get install -y cmake

      - name: Compilation et Tests CTest
        run: |
          mkdir build
          cd build
          cmake ..
          make
          ctest # Ex√©cute tous les tests (add, sub, mul, div, carre)
          # Ce job sert de v√©rification globale de base
  
  # ----------------------------------------------------
  # JOBS DE TESTS PARALL√àLES (D√©pendent de la compilation r√©ussie)
  # ----------------------------------------------------
  
  Test_Add:
    runs-on: ubuntu-latest
    needs: Compilation # D√©marre UNIQUEMENT apr√®s Compilation
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      - name: Recompiler et Tester la fonction add
        run: |
          mkdir build; cd build
          cmake ..; make
          ./src/calculator add 10 5 | grep "15" # Exemple de test avec v√©rification

  Test_Sub:
    runs-on: ubuntu-latest
    needs: Compilation # D√©marre UNIQUEMENT apr√®s Compilation
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      - name: Recompiler et Tester la fonction sub
        run: |
          mkdir build; cd build
          cmake ..; make
          ./src/calculator sub 10 5 | grep "5" # Exemple de test avec v√©rification
          
  Test_Carre:
    runs-on: ubuntu-latest
    needs: Compilation # D√©marre UNIQUEMENT apr√®s Compilation
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      - name: Recompiler et Tester la fonction carre
        run: |
          mkdir build; cd build
          cmake ..; make
          ./src/calculator car 5 | grep "25" # Test de votre nouvelle fonction

  # ----------------------------------------------------
  # JOB FINAL : D√âPLOIEMENT (D√©pend de tous les tests)
  # ----------------------------------------------------
  Deploy:
    runs-on: ubuntu-latest
    # D√©marre UNIQUEMENT si TOUS les jobs de test pr√©c√©dents ont r√©ussi
    needs: [Test_Add, Test_Sub, Test_Carre] 
    steps:
      - name: D√©ploiement de la solution
        run: echo "üéâ D√©ploiement de la solution r√©ussi !"
